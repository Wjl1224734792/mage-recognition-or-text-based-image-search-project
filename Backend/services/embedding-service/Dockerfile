# åµŒå…¥æœåŠ¡ Dockerfile
FROM node:22.21.1-trixie-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# ä½¿ç”¨å›½å†…é•œåƒæºï¼ˆDebian Trixie æ¸…åé•œåƒ + npm npmmirrorï¼‰
RUN printf "deb http://mirrors.tuna.tsinghua.edu.cn/debian/ trixie main contrib non-free non-free-firmware\n" \
  > /etc/apt/sources.list \
  && printf "deb http://mirrors.tuna.tsinghua.edu.cn/debian/ trixie-updates main contrib non-free non-free-firmware\n" \
  >> /etc/apt/sources.list \
  && printf "deb http://mirrors.tuna.tsinghua.edu.cn/debian/ trixie-backports main contrib non-free non-free-firmware\n" \
  >> /etc/apt/sources.list \
  && printf "deb http://mirrors.tuna.tsinghua.edu.cn/debian-security trixie-security main contrib non-free non-free-firmware\n" \
  >> /etc/apt/sources.list \
  && npm config set registry https://mirrors.huaweicloud.com/repository/npm/

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y --no-install-recommends \
    libvips-dev \
    gcc \
    g++ \
    make \
    && rm -rf /var/lib/apt/lists/*  # æ¸…ç†ç¼“å­˜ï¼Œå‡å°é•œåƒä½“ç§¯

# å®‰è£…/æ›´æ–° yarnï¼ˆå¦‚æœä¸å­˜åœ¨æˆ–éœ€è¦æ›´æ–°ï¼‰- ä½¿ç”¨ --force é¿å…å†²çª
RUN npm install -g yarn --force || true

# å¤åˆ¶æ‰€æœ‰æ–‡ä»¶åˆ°å®¹å™¨ï¼ˆåŒ…æ‹¬ Windows ç‰ˆæœ¬çš„ node_modulesï¼‰
COPY . .

# å¼ºåˆ¶é‡æ–°å®‰è£… sharpï¼Œç¡®ä¿ä½¿ç”¨ Linux ç‰ˆæœ¬ï¼ˆè¦†ç›– Windows ç‰ˆæœ¬ï¼‰
# åˆ é™¤ Windows ç‰ˆæœ¬çš„ sharpï¼Œç„¶åä½¿ç”¨ yarn å•ç‹¬å®‰è£… Linux ç‰ˆæœ¬
# åœ¨å®¹å™¨å†…ï¼Œä¼šè‡ªåŠ¨å®‰è£…åŒ¹é…å½“å‰ Linux å¹³å°çš„ç‰ˆæœ¬
RUN echo "ğŸ—‘ï¸ åˆ é™¤ Windows ç‰ˆæœ¬çš„ sharp..." && \
    rm -rf node_modules/sharp services/embedding-service/node_modules/sharp && \
    cd services/embedding-service && \
    echo "ğŸ“¦ ä½¿ç”¨ yarn å•ç‹¬å®‰è£… Linux ç‰ˆæœ¬çš„ sharp..." && \
    (yarn add sharp --force || \
     (echo "âš ï¸ yarn å®‰è£…å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ npm..." && npm install sharp --force) || \
     (echo "âš ï¸ npm å•ç‹¬å®‰è£…å¤±è´¥ï¼Œå›é€€åˆ°é‡æ–°å®‰è£…æ‰€æœ‰ä¾èµ–..." && yarn install --force || npm install --force)) && \
    echo "âœ… sharp å®‰è£…å®Œæˆ"

# åˆ›å»ºå¿…è¦çš„ç›®å½•
RUN mkdir -p /app/config /app/utils /app/models /app/.cache

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV PORT=3002

# æš´éœ²ç«¯å£
EXPOSE 3002

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3002/health || exit 1

# å¯åŠ¨å‘½ä»¤
CMD ["node", "services/embedding-service/index.js"]
